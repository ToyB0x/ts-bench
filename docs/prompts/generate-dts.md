# TypeScript型定義ファイル生成の実装ガイド

> このガイドは[TypeScript最適化のメタプロンプト](./_meta.md)の「内部パッケージdts生成」手法の詳細実装ドキュメントです。

## 手法概要

**内部パッケージdts生成**は、モノレポ内パッケージの型定義ファイル（.d.ts）を事前生成することで、依存側での型チェック負荷を削減し、開発時の応答性を向上させる最適化手法です。

### 評価指標
- **実装容易度**: ⭐⭐ (数日の複雑変更)
- **段階実装**: ⭐⭐ (制約ありの部分実装)  
- **AI自動化**: ⭐⭐ (限定サポート)
- **性能影響**: ⭐⭐⭐ (10-20%改善)
- **デグレリスク**: ⭐ (ほぼなし)

## 背景と効果

型定義ファイルの生成を適切に設定することで以下の改善が期待できます：

### 主要な効果
- **IDEでの型推論の精度向上**: 事前生成された型定義により、IDE上での型情報表示が高速化
- **開発者の生産性向上**: インテリセンスやエラー検出の応答性改善  
- **型安全性の向上**: 明示的な型定義による実行時エラーの削減
- **TypeScriptコンパイル時のパフォーマンス改善**: 依存側での型推論処理負荷を削減

### 他手法との連携効果
この手法は以下の最適化手法と組み合わせることで、さらなる性能向上が期待できます：
- [明示的型注釈](./_meta.md#2-コード構造最適化): 型推論処理を削減 (⭐⭐⭐⭐ 性能影響)
- [isolatedDeclarations](./_meta.md#1-設定最適化): 並列処理と宣言ファイル生成を高速化 (⭐⭐⭐⭐ 性能影響)
- [package.json exports最適化](./_meta.md#3-プロジェクト構造最適化): 公開API制御と不要な依存解決排除 (⭐⭐⭐ 性能影響)

## 型定義ファイル未生成パッケージの特定

以下のような条件のパッケージを対象とします：

- 実際のコードを含む（設定ファイルのみではない）
- build または dist ディレクトリを持つ
- 他のパッケージから利用される可能性がある
- 現在 .d.ts ファイルを生成していない

**重要:** 設定ファイルのみを含むパッケージはスキップし、実際のコードとbuild/distディレクトリを持つパッケージに焦点を当てます。

## 実装手順

選択した各パッケージに対して：

1. **パッケージ構造の確認**:
    - 実際のコードを含むことを確認（設定ファイルのみではない）
    - build または dist ディレクトリがあることを確認
    - 既存のビルド設定（tsup.config.ts など）を確認

2. **TypeScript型定義ファイル生成の追加**:

   パッケージがtsupを使用している場合、tsup.config.tsファイルを修正：
   ```diff
   export default defineConfig({
     clean: true,
     target: 'es2022',
     entry: ['src/index.ts'],
     format: ['esm'],
     minify: true,
     sourcemap: true,
   +  dts: false, // tsupはdeclarationMapに対応していないため、dtsをfalseにし、tscを使って型定義ファイルを生成する
   +  onSuccess: 'pnpm build:types',
   })
   ```

   package.jsonにbuild:typesスクリプトを追加：
   ```diff
   "scripts": {
     "build": "tsup",
   +  "build:types": "tsc --emitDeclarationOnly --declaration --declarationMap"
   }
   ```

   tsconfig.jsonで適切な宣言設定を確保：
   ```json
   {
     "compilerOptions": {
       "declaration": true,
       "declarationMap": true
     }
   }
   ```

## 実装パターン

コードベース分析に基づいて、TypeScript型定義生成には以下のようなパターンがあります：

1. **tsupで `dts: true` を使用**:
   一部のパッケージでは、tsupの組み込み型定義生成を直接使用します。

2. **tsupで `dts: false` と別のtscコマンドを使用**:
   より高度なパッケージでは以下のような設定を使用します：
   ```javascript
   dts: false, // tsupはdeclarationMapに対応していないため、dtsをfalseにし、tscを使って型定義ファイルを生成する
   onSuccess: 'pnpm build:types',
   ```
   このアプローチは宣言マップをサポートするため推奨されます。

3. **Viteでunplugin-dtsを使用**:
   データベースパッケージなどでは以下のような設定を使用します：
   ```javascript
   dts({ bundleTypes: false, tsconfigPath: './tsconfig.build.json', entryRoot: 'src' }),
   ```

パッケージの既存のビルド設定に基づいて適切なパターンを選択してください。

## 実装時の要件

各実装において：
1. パッケージごとに個別の作業を実施
2. 全てのCIチェックが通ることを確認
3. TypeScriptベンチマーク結果の改善を確認
4. 変更は最小限に留め、型定義ファイル生成の追加に焦点を当てる

## 成果物

1. 型定義ファイル生成を実装した各パッケージ
2. 各実装には以下を含める：
    - 修正されたビルド設定ファイル
    - 必要に応じて更新されたpackage.jsonスクリプト
    - 必要なtsconfig.jsonの変更

## AI実装時の推奨フロー

1. **対象パッケージ特定**: 他パッケージから参照される実コード含有パッケージを優先
2. **ビルド設定分析**: 既存のtsup/vite設定を確認し適切なパターンを選択
3. **段階的実装**: パッケージ単位で型定義生成を追加、各回でCI通過を確認
4. **性能測定**: ts-benchで実装前後の改善効果を定量化

## 注意事項

- Turborepoとの整合性を維持
- 複数パッケージから参照されるライブラリを優先実装
- 変更は型定義生成追加に限定し最小限に留める
